<div class="relative">
  <!-- Trigger button -->
  <button (click)="toggleDropdown()"
          class="flex h-9 items-center gap-2 rounded-lg px-2 transition-all"
          [class]="isGameActive()
            ? 'cursor-not-allowed opacity-50'
            : 'hover:bg-slate-100 dark:hover:bg-slate-800 cursor-pointer'"
          [attr.aria-label]="isGameActive() ? 'Language switching disabled during game' : 'Change language'"
          [attr.aria-expanded]="isDropdownOpen()"
          [disabled]="isGameActive()"
          data-testid="language-switcher-button">
    <!-- Current language flag -->
    <span class="text-xl">{{ getCurrentFlag() }}</span>
    <!-- Language name (desktop) or code (mobile) -->
    <span class="hidden md:block text-sm font-medium text-slate-600 dark:text-slate-400">
      {{ currentLanguage().nativeName }}
    </span>
    <span class="md:hidden text-xs font-medium text-slate-600 dark:text-slate-400 uppercase">
      {{ currentLanguage().code }}
    </span>
    <!-- Dropdown arrow -->
    <svg class="h-3 w-3 text-slate-500 transition-transform"
         [class.rotate-180]="isDropdownOpen()"
         [class]="isGameActive() ? 'text-slate-300 dark:text-slate-600' : 'text-slate-500'"
         fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <!-- Dropdown menu -->
  @if (isDropdownOpen()) {
    <div class="dropdown-menu absolute right-0 mt-2 w-40 rounded-lg bg-white dark:bg-slate-800 shadow-lg ring-1 ring-black ring-opacity-5 z-50"
         data-testid="language-dropdown">
      @for (lang of availableLanguages(); track lang.code) {
        <button (click)="selectLanguage(lang.code)"
                class="flex w-full items-center gap-3 px-4 py-2.5 text-left hover:bg-slate-100 dark:hover:bg-slate-700 first:rounded-t-lg last:rounded-b-lg"
                [class.bg-slate-100]="lang.code === currentLanguage().code"
                [class.dark:bg-slate-700]="lang.code === currentLanguage().code"
                [attr.data-testid]="'language-option-' + lang.code">
          <span class="text-xl">{{ lang.flag }}</span>
          <div class="flex flex-col">
            <span class="text-sm font-medium text-slate-900 dark:text-slate-100">{{ lang.name }}</span>
            <span class="text-xs text-slate-500 dark:text-slate-400">{{ lang.nativeName }}</span>
          </div>
        </button>
      }
    </div>
  }
</div>

<!-- Click outside to close -->
@if (isDropdownOpen()) {
  <div (click)="closeDropdown()"
       class="fixed inset-0 z-40"
       aria-hidden="true"></div>
}
